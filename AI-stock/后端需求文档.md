# AI财报分析系统 - 后端需求文档

## 项目概述

AI财报分析系统是一个纯Go语言实现的自动化财务报告分析工具，主要功能是从巨潮信息网（CNINFO）获取上市公司的财务报告，并提供统一的Web服务。

## 后端架构设计

### 技术栈
- **主要语言**: Go 1.21+
- **Web框架**: Gin
- **HTTP客户端**: 标准库 net/http
- **JSON处理**: 标准库 encoding/json
- **文件系统**: 标准库 os, io/fs
- **前端嵌入**: Go embed 功能

### 核心模块
1. **HTTP服务器** (`main.go`) - 主服务器和路由处理
2. **报告下载器** (`main.go:25-57`) - 财报下载功能
3. **文件管理器** (`main.go:349-405`) - 文件列表和管理
4. **静态文件服务** - 前端资源和下载文件服务

## API接口需求

### 1. 获取财报列表接口
- **路径**: `GET /api/reports`
- **功能**: 获取已下载的财报文件列表
- **实现**: 扫描 `downloads/` 目录，按公司和年份组织
- **响应格式**:
```json
{
  "reports": [
    {
      "title": "2024年年度报告_云南白药",
      "file_name": "2024年年度报告_云南白药.pdf",
      "file_path": "downloads/云南白药/2024/2024年年度报告_云南白药.pdf"
    }
  ]
}
```

### 2. 下载财报接口
- **路径**: `POST /api/download`
- **功能**: 根据公司名称和年份下载财报
- **请求参数**:
```json
{
  "company_name": "云南白药",
  "year": "2024"
}
```
- **响应格式**:
```json
{
  "message": "下载成功",
  "files": [
    {
      "title": "2024年年度报告_云南白药",
      "file_name": "2024年年度报告_云南白药.pdf",
      "file_path": "downloads/云南白药/2024/2024年年度报告_云南白药.pdf"
    }
  ]
}
```

## 数据下载需求

### 1. 公司搜索功能
- **接口**: 巨潮信息网搜索API
- **功能**: 根据公司名称获取股票代码和组织ID
- **URL**: `http://www.cninfo.com.cn/new/information/topSearch/query`
- **方法**: POST请求，表单数据格式
- **参数**: keyWord（公司名称）, maxNum（最大结果数）

### 2. 报告下载功能
- **接口**: 巨潮信息网历史公告查询API
- **URL**: `http://www.cninfo.com.cn/new/hisAnnouncement/query`
- **方法**: POST请求，表单数据格式
- **支持的报告类型**:
  - 第一季度报告
  - 半年度报告
  - 第三季度报告
  - 年度报告

### 3. 下载策略
- **年份处理**: 如果指定年份没有报告，自动回退到最近可用年份（最多回退2年）
- **文件去重**: 检查文件是否已存在，避免重复下载
- **错误处理**: 处理网络异常、API限制等情况
- **重试机制**: 年份递减重试直到找到可用报告

### 4. 文件命名规范
- **格式**: `{年份}年{报告类型}_{公司名称}.pdf`
- **示例**: `2024年年度报告_云南白药.pdf`
- **目录结构**: `downloads/{公司名称}/{年份}/`

## 文件管理需求

### 1. 目录结构
```
downloads/
├── 公司名称/
│   ├── 年份/
│   │   ├── 年份年报告类型_公司名称.pdf
```

### 2. 文件类型支持
- **输入**: PDF格式财报文件
- **输出**: 仅提供PDF文件下载，暂不提供解析功能

### 3. 文件服务
- **静态文件服务**: 通过 `/downloads` 路径提供文件访问
- **文件扫描**: 自动扫描并返回可用的财报文件列表
- **路径处理**: 统一使用正斜杠作为路径分隔符

### 4. 文件组织
- **按公司分组**: 同一公司的报告放在同一目录下
- **按年份分组**: 同一年的报告放在同一目录下
- **文件列表**: 按路径扫描，支持多层级目录结构

## 性能需求

### 1. 响应时间
- **文件列表查询**: < 1秒（取决于文件数量）
- **报告下载**: 根据文件大小和网络状况
- **静态文件服务**: 快速响应

### 2. 并发处理
- **Go协程**: 利用Go的并发特性处理多个请求
- **连接池**: 复用HTTP连接提高效率
- **内存管理**: 合理控制内存使用，避免内存泄漏

### 3. 错误处理
- **网络异常**: 自动重试机制和优雅降级
- **文件系统错误**: 处理文件读写权限问题
- **API错误**: 处理外部API的异常响应

## 安全需求

### 1. 输入验证
- **参数验证**: 验证API请求参数的合法性
- **路径验证**: 防止路径遍历攻击
- **文件类型检查**: 限制处理的文件类型

### 2. 访问控制
- **CORS配置**: 允许前端跨域访问
- **请求限制**: 防止接口滥用
- **文件权限**: 设置适当的文件访问权限

### 3. 数据安全
- **敏感信息**: 不记录敏感的用户输入
- **文件安全**: 确保下载的文件不包含恶意内容
- **日志安全**: 不记录敏感信息到日志

## 部署需求

### 1. 环境配置
- **Go版本**: 1.21+
- **依赖管理**: go.mod 和 go.sum
- **交叉编译**: 支持多平台编译

### 2. 服务配置
- **端口**: 8080
- **静态文件**: 支持前端文件嵌入
- **自动启动**: 启动时自动打开浏览器

### 3. 构建和部署
- **单一二进制文件**: 编译为单个可执行文件
- **前端嵌入**: 使用Go embed功能嵌入前端资源
- **跨平台支持**: 支持Windows、macOS、Linux、Android

## 扩展需求

### 1. 功能扩展
- **PDF解析**: 集成PDF解析库提取财务数据
- **数据分析**: 添加财务数据分析和可视化功能
- **用户管理**: 支持多用户和权限管理

### 2. 性能优化
- **缓存机制**: 缓存常用数据和API响应
- **数据库集成**: 添加数据库支持存储元数据
- **异步处理**: 使用Go的channel进行异步处理

### 3. 监控和日志
- **访问日志**: 记录API访问情况
- **错误监控**: 监控系统错误和异常
- **性能监控**: 监控系统资源使用情况

## 测试需求

### 1. 单元测试
- **API测试**: 测试所有API接口的正确性
- **下载功能测试**: 测试报告下载功能
- **文件管理测试**: 测试文件扫描和管理功能

### 2. 集成测试
- **端到端测试**: 完整的下载和访问流程
- **性能测试**: 测试并发访问和大量文件处理
- **兼容性测试**: 测试不同平台的兼容性

### 3. 用户测试
- **界面测试**: 前后端交互测试
- **用户体验**: 实际使用场景测试
- **反馈收集**: 收集用户使用反馈

## 维护需求

### 1. 代码质量
- **代码规范**: 遵循Go语言编码规范
- **错误处理**: 统一的错误处理机制
- **日志记录**: 详细的操作和错误日志

### 2. 依赖管理
- **版本控制**: 固定关键依赖版本
- **安全更新**: 定期更新安全补丁
- **兼容性**: 保持向后兼容性

### 3. 运维支持
- **部署脚本**: 自动化部署流程
- **监控告警**: 系统运行状态监控
- **故障恢复**: 快速故障诊断和恢复

## 技术特点

### 1. Go语言优势
- **高性能**: 原生编译，执行效率高
- **并发性**: 天然支持高并发
- **跨平台**: 一次编写，多平台编译
- **部署简单**: 单个二进制文件，无依赖

### 2. 架构优势
- **简化架构**: 移除了Python复杂度，统一技术栈
- **嵌入式前端**: 前端资源嵌入到二进制文件中
- **静态类型**: Go的静态类型系统提高代码质量
- **内存管理**: 自动垃圾回收，避免内存泄漏

### 3. 开发效率
- **快速编译**: Go编译速度快
- **标准库丰富**: 内置大量实用库
- **工具链完善**: gofmt、golint等工具支持
- **社区活跃**: 丰富的第三方库支持