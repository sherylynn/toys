<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI股票价值投资分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .analysis-result {
            display: none;
        }

        .basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .score-section {
            text-align: center;
            margin: 30px 0;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            color: white;
        }

        .score-excellent { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .score-good { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .score-average { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .score-poor { background: linear-gradient(135deg, #f44336, #d32f2f); }

        .recommendation {
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .recommendation-buy { background: #e8f5e8; color: #2e7d32; }
        .recommendation-hold { background: #e3f2fd; color: #1565c0; }
        .recommendation-watch { background: #fff3e0; color: #ef6c00; }
        .recommendation-sell { background: #ffebee; color: #c62828; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-desc {
            font-size: 12px;
            color: #999;
        }

        .charts-section {
            margin: 30px 0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item a {
            color: #667eea;
            text-decoration: none;
        }

        .file-item a:hover {
            text-decoration: underline;
        }

        .positive { color: #4CAF50; }
        .negative { color: #f44336; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI股票价值投资分析系统</h1>
        <p>智能财报下载 + 价值投资分析</p>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('download')">财报下载</button>
            <button class="nav-tab" onclick="switchTab('analysis')">价值投资分析</button>
            <button class="nav-tab" onclick="switchTab('positions')">持仓管理</button>
        </div>

        <!-- 财报下载标签页 -->
        <div id="download-tab" class="tab-content active">
            <div class="card">
                <h2>财报下载系统</h2>
                <div class="form-group">
                    <label for="companyName">公司名称</label>
                    <input type="text" id="companyName" placeholder="请输入公司名称" value="云南白药">
                </div>
                <div class="form-group">
                    <label for="year">年份（可选）</label>
                    <input type="text" id="year" placeholder="请输入年份" value="2024">
                </div>
                <button class="btn" onclick="downloadReports()" id="downloadBtn">下载财报</button>
                <div id="downloadMessage"></div>
                <div id="downloadedFiles" class="file-list"></div>
            </div>
        </div>

        <!-- 价值投资分析标签页 -->
        <div id="analysis-tab" class="tab-content">
            <div class="card">
                <h2>价值投资分析</h2>
                <div class="form-group">
                    <label for="stockName">股票名称/代码</label>
                    <input type="text" id="stockName" placeholder="请输入股票名称或代码（如：云南白药 或 000538）" value="云南白药">
                </div>
                <button class="btn" onclick="analyzeStock()" id="analyzeBtn">分析</button>
                <div id="analysisMessage"></div>
            </div>

            <div id="analysisResult" class="analysis-result">
                <!-- 基本信息 -->
                <div class="card">
                    <h3>基本信息</h3>
                    <div class="basic-info" id="basicInfo"></div>
                </div>

                <!-- 价值评分 -->
                <div class="card">
                    <h3>价值评分</h3>
                    <div class="score-section">
                        <div class="score-circle" id="scoreCircle"></div>
                        <div class="recommendation" id="recommendation"></div>
                        <div id="analysisTime"></div>
                    </div>
                </div>

                <!-- 财务指标 -->
                <div class="card">
                    <h3>财务指标</h3>
                    <div class="metrics-grid" id="metricsGrid"></div>
                </div>

                <!-- 图表展示 -->
                <div class="card">
                    <h3>指标图表</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">估值指标雷达图</div>
                            <canvas id="valuationChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">成长性指标柱状图</div>
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 持仓管理标签页 -->
        <div id="positions-tab" class="tab-content">
            <div class="card">
                <h2>持仓管理</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="showAddPositionModal()">添加持仓</button>
                    <button class="btn" onclick="updatePrices()" style="margin-left: 10px;">更新价格</button>
                    <button class="btn" onclick="loadPositions()" style="margin-left: 10px;">刷新</button>
                </div>
                <div id="positionsMessage"></div>
                
                <!-- 持仓列表 -->
                <div id="positionsList"></div>
                
                <!-- 持仓统计 -->
                <div id="positionsSummary" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <!-- 添加持仓模态框 -->
    <div id="addPositionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; min-width: 400px;">
            <h3>添加持仓</h3>
            <div class="form-group">
                <label for="modalStockCode">股票代码</label>
                <input type="text" id="modalStockCode" placeholder="如：000538">
            </div>
            <div class="form-group">
                <label for="modalStockName">股票名称</label>
                <input type="text" id="modalStockName" placeholder="如：云南白药">
            </div>
            <div class="form-group">
                <label for="modalShares">持仓数量</label>
                <input type="number" id="modalShares" placeholder="如：100">
            </div>
            <div class="form-group">
                <label for="modalBuyPrice">买入价格</label>
                <input type="number" id="modalBuyPrice" step="0.01" placeholder="如：55.50">
            </div>
            <div class="form-group">
                <label for="modalNotes">备注</label>
                <input type="text" id="modalNotes" placeholder="可选">
            </div>
            <div style="text-align: right;">
                <button class="btn" onclick="hideAddPositionModal()" style="margin-right: 10px;">取消</button>
                <button class="btn" onclick="addPosition()">确定</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        const API_BASE = '/api';
        let valuationChart = null;
        let growthChart = null;

        function switchTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签页
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        async function downloadReports() {
            const companyName = document.getElementById('companyName').value;
            const year = document.getElementById('year').value;
            const btn = document.getElementById('downloadBtn');

            if (!companyName) {
                showMessage('downloadMessage', '请输入公司名称', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '下载中...';

            try {
                const response = await fetch(`${API_BASE}/download`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        company_name: companyName,
                        year: year || null
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('downloadMessage', '财报下载成功！', 'success');
                    displayDownloadedFiles(result.files);
                } else {
                    showMessage('downloadMessage', result.error || '下载失败', 'error');
                }
            } catch (error) {
                showMessage('downloadMessage', '网络错误，请稍后重试', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '下载财报';
            }
        }

        function displayDownloadedFiles(files) {
            const container = document.getElementById('downloadedFiles');
            if (files && files.length > 0) {
                container.innerHTML = '<h3>已下载的报表：</h3>' +
                    files.map(file => `
                        <div class="file-item">
                            <a href="/${file.file_path}" target="_blank">${file.title}</a>
                        </div>
                    `).join('');
            }
        }

        async function analyzeStock() {
            const stockName = document.getElementById('stockName').value;
            const btn = document.getElementById('analyzeBtn');

            if (!stockName) {
                showMessage('analysisMessage', '请输入股票名称或代码', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '分析中...';

            try {
                const response = await fetch(`${API_BASE}/value-investment/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_name: stockName
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayAnalysisResult(result.data);
                    showMessage('analysisMessage', '分析完成！', 'success');
                } else {
                    showMessage('analysisMessage', result.message || '分析失败', 'error');
                }
            } catch (error) {
                showMessage('analysisMessage', '网络错误，请稍后重试', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '分析';
            }
        }

        function displayAnalysisResult(data) {
            // 显示分析结果区域
            document.getElementById('analysisResult').style.display = 'block';

            // 基本信息
            const basicInfo = document.getElementById('basicInfo');
            basicInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">股票代码</div>
                    <div class="info-value">${data.code}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">股票名称</div>
                    <div class="info-value">${data.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">当前价格</div>
                    <div class="info-value">¥${data.price?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">涨跌幅</div>
                    <div class="info-value ${data.changePct >= 0 ? 'positive' : 'negative'}">
                        ${data.changePct?.toFixed(2) || 'N/A'}%
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">成交量</div>
                    <div class="info-value">${formatVolume(data.volume)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">成交额</div>
                    <div class="info-value">¥${formatAmount(data.amount)}</div>
                </div>
            `;

            // 价值评分
            const scoreCircle = document.getElementById('scoreCircle');
            scoreCircle.className = `score-circle ${getScoreClass(data.value_score)}`;
            scoreCircle.textContent = data.value_score;

            const recommendation = document.getElementById('recommendation');
            recommendation.className = `recommendation ${getRecommendationClass(data.value_score)}`;
            recommendation.textContent = data.recommendation;

            document.getElementById('analysisTime').textContent = `分析时间: ${data.analysis_time}`;

            // 财务指标
            const metrics = [
                { key: 'pe_ratio', label: '市盈率(P/E)', desc: '股价与每股收益的比率' },
                { key: 'pb_ratio', label: '市净率(P/B)', desc: '股价与每股净资产的比率' },
                { key: 'roe', label: '净资产收益率(ROE)', desc: '净利润与净资产的比率' },
                { key: 'debt_ratio', label: '资产负债率', desc: '总负债与总资产的比率' },
                { key: 'current_ratio', label: '流动比率', desc: '流动资产与流动负债的比率' },
                { key: 'gross_margin', label: '毛利率', desc: '毛利与营业收入的比率' },
                { key: 'net_margin', label: '净利率', desc: '净利润与营业收入的比率' },
                { key: 'revenue_growth', label: '营收增长率', desc: '营业收入同比增长率' },
                { key: 'profit_growth', label: '利润增长率', desc: '净利润同比增长率' },
                { key: 'dividend_yield', label: '股息率', desc: '年度股息与当前股价的比率' },
                { key: 'eps', label: '每股收益(EPS)', desc: '净利润与总股本的比率' },
                { key: 'bvps', label: '每股净资产(BVPS)', desc: '净资产与总股本的比率' }
            ];

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-title">${metric.label}</div>
                    <div class="metric-value">${formatMetric(metric.key, data[metric.key])}</div>
                    <div class="metric-desc">${metric.desc}</div>
                </div>
            `).join('');

            // 图表
            renderCharts(data);
        }

        function renderCharts(data) {
            // 销毁现有图表
            if (valuationChart) valuationChart.destroy();
            if (growthChart) growthChart.destroy();

            // 估值指标雷达图
            const valuationCtx = document.getElementById('valuationChart').getContext('2d');
            valuationChart = new Chart(valuationCtx, {
                type: 'radar',
                data: {
                    labels: ['市盈率', '市净率', '净资产收益率', '股息率', '毛利率'],
                    datasets: [{
                        label: '估值指标',
                        data: [
                            // 市盈率：越低越好，转换为分数（15-25倍为最佳区间）
                            data.pe_ratio ? Math.max(0, Math.min(100, 100 - Math.abs(data.pe_ratio - 20) * 2)) : 0,
                            
                            // 市净率：越低越好，转换为分数（1-3倍为最佳区间）
                            data.pb_ratio ? Math.max(0, Math.min(100, 100 - Math.abs(data.pb_ratio - 2) * 20)) : 0,
                            
                            // 净资产收益率：越高越好，直接转换为分数
                            Math.min(data.roe || 0, 100),
                            
                            // 股息率：越高越好，放大到合适范围
                            Math.min((data.dividend_yield || 0) * 20, 100),
                            
                            // 毛利率：越高越好，直接使用
                            Math.min(data.gross_margin || 0, 100)
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // 成长性柱状图
            const growthCtx = document.getElementById('growthChart').getContext('2d');
            growthChart = new Chart(growthCtx, {
                type: 'bar',
                data: {
                    labels: ['营收增长', '利润增长', 'ROE', '净利率'],
                    datasets: [{
                        label: '成长性指标 (%)',
                        data: [
                            data.revenue_growth || 0,
                            data.profit_growth || 0,
                            data.roe || 0,
                            data.net_margin || 0
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function formatVolume(volume) {
            if (!volume) return '0';
            if (volume >= 100000000) return (volume / 100000000).toFixed(2) + '亿';
            if (volume >= 10000) return (volume / 10000).toFixed(2) + '万';
            return volume.toString();
        }

        function formatAmount(amount) {
            if (!amount) return '0';
            if (amount >= 100000000) return (amount / 100000000).toFixed(2) + '亿';
            if (amount >= 10000) return (amount / 10000).toFixed(2) + '万';
            return amount.toFixed(2);
        }

        function formatMetric(key, value) {
            if (value === null || value === undefined) return 'N/A';
            
            switch (key) {
                case 'pe_ratio':
                case 'pb_ratio':
                case 'ps_ratio':
                case 'current_ratio':
                    return value.toFixed(2);
                case 'roe':
                case 'debt_ratio':
                case 'gross_margin':
                case 'net_margin':
                case 'revenue_growth':
                case 'profit_growth':
                case 'dividend_yield':
                    return value.toFixed(2) + '%';
                case 'eps':
                case 'bvps':
                    return '¥' + value.toFixed(2);
                default:
                    return value.toString();
            }
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            if (score >= 40) return 'score-average';
            return 'score-poor';
        }

        function getRecommendationClass(score) {
            if (score >= 80) return 'recommendation-buy';
            if (score >= 60) return 'recommendation-hold';
            if (score >= 40) return 'recommendation-watch';
            return 'recommendation-sell';
        }

        // 持仓管理相关函数
        function showAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'block';
        }

        function hideAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'none';
            // 清空表单
            document.getElementById('modalStockCode').value = '';
            document.getElementById('modalStockName').value = '';
            document.getElementById('modalShares').value = '';
            document.getElementById('modalBuyPrice').value = '';
            document.getElementById('modalNotes').value = '';
        }

        async function addPosition() {
            const stockCode = document.getElementById('modalStockCode').value;
            const stockName = document.getElementById('modalStockName').value;
            const shares = parseInt(document.getElementById('modalShares').value);
            const buyPrice = parseFloat(document.getElementById('modalBuyPrice').value);
            const notes = document.getElementById('modalNotes').value;

            if (!stockCode || !stockName || !shares || !buyPrice) {
                alert('请填写完整的持仓信息');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/positions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        stock_name: stockName,
                        shares: shares,
                        buy_price: buyPrice,
                        notes: notes
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    hideAddPositionModal();
                    showMessage('positionsMessage', '持仓添加成功！', 'success');
                    loadPositions();
                } else {
                    showMessage('positionsMessage', result.error || '添加失败', 'error');
                }
            } catch (error) {
                showMessage('positionsMessage', '网络错误，请稍后重试', 'error');
            }
        }

        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE}/positions`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayPositions(result.data);
                    displayPositionsSummary(result.data);
                } else {
                    showMessage('positionsMessage', result.error || '获取持仓失败', 'error');
                }
            } catch (error) {
                showMessage('positionsMessage', '网络错误，请稍后重试', 'error');
            }
        }

        function displayPositions(positions) {
            const container = document.getElementById('positionsList');
            
            if (positions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">暂无持仓记录</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">股票代码</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">股票名称</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">持仓数量</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">买入价格</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">当前价格</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">盈亏金额</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">盈亏比例</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${positions.map(position => `
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;">${position.stock_code}</td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${position.stock_name}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${position.shares.toLocaleString()}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">¥${position.buy_price.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">¥${position.current_price.toFixed(2)}</td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${position.profit_loss >= 0 ? '#4CAF50' : '#f44336'};">
                                    ¥${position.profit_loss.toFixed(2)}
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd; text-align: right; color: ${position.profit_rate >= 0 ? '#4CAF50' : '#f44336'};">
                                    ${position.profit_rate.toFixed(2)}%
                                </td>
                                <td style="padding: 12px; border: 1px solid #ddd;">
                                    <button onclick="deletePosition(${position.id})" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">删除</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayPositionsSummary(positions) {
            const container = document.getElementById('positionsSummary');
            
            if (positions.length === 0) {
                container.innerHTML = '';
                return;
            }

            const totalCost = positions.reduce((sum, p) => sum + p.total_cost, 0);
            const totalValue = positions.reduce((sum, p) => sum + p.current_value, 0);
            const totalProfitLoss = totalValue - totalCost;
            const totalProfitRate = totalCost > 0 ? (totalProfitLoss / totalCost) * 100 : 0;

            container.innerHTML = `
                <div class="card">
                    <h3>持仓统计</h3>
                    <div class="basic-info">
                        <div class="info-item">
                            <div class="info-label">持仓数量</div>
                            <div class="info-value">${positions.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">总成本</div>
                            <div class="info-value">¥${totalCost.toFixed(2)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">当前市值</div>
                            <div class="info-value">¥${totalValue.toFixed(2)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">总盈亏</div>
                            <div class="info-value ${totalProfitLoss >= 0 ? 'positive' : 'negative'}">
                                ¥${totalProfitLoss.toFixed(2)}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">总收益率</div>
                            <div class="info-value ${totalProfitRate >= 0 ? 'positive' : 'negative'}">
                                ${totalProfitRate.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function deletePosition(id) {
            if (!confirm('确定要删除这个持仓吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/positions/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage('positionsMessage', '持仓删除成功！', 'success');
                    loadPositions();
                } else {
                    showMessage('positionsMessage', result.error || '删除失败', 'error');
                }
            } catch (error) {
                showMessage('positionsMessage', '网络错误，请稍后重试', 'error');
            }
        }

        async function updatePrices() {
            try {
                const response = await fetch(`${API_BASE}/positions/update-prices`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage('positionsMessage', '价格更新成功！', 'success');
                    loadPositions();
                } else {
                    showMessage('positionsMessage', result.error || '更新失败', 'error');
                }
            } catch (error) {
                showMessage('positionsMessage', '网络错误，请稍后重试', 'error');
            }
        }

        // 页面加载时自动分析默认股票
        window.onload = function() {
            // 可以在这里添加初始化代码
        };
    </script>
</body>
</html>