# 菜单栏应用逻辑文档

## 概述
macOS菜单栏ADB设备管理器提供智能的设备分类和菜单结构，根据目标设备设置自动调整菜单层级。

## 核心逻辑

### 1. 设备分类
- **目标设备**：设备型号名称包含目标字符串（默认"110"）的设备
- **其他设备**：不包含目标字符串的设备

### 2. 智能菜单结构

#### 场景A：有目标设备时
```
📱 (设备总数)
├── 🔄 刷新设备
├── 🔍 扫描设备
├── 🎯 目标设备名称 (IP)        [灰色标题，不可点击]
│   ├── 📱 Scrcpy             [可直接点击]
│   ├── 🟢 SC                 [可直接点击]
│   ├── 🟡 SCA                [可直接点击]
│   ├── 🔴 SCB                [可直接点击]
│   └── 🔌 断开连接           [可直接点击]
├── 其他设备 (N)              [子菜单]
│   └── 设备名称 (IP)         [可点击，有子菜单]
│       ├── 📱 Scrcpy
│       ├── 🟢 SC
│       ├── 🟡 SCA
│       ├── 🔴 SCB
│       └── 🔌 断开连接
├── ⚙️ 设置
├── 📋 历史记录
├── 🚀 启动GUI服务器
├── 🛑 停止GUI服务器
└── ❌ 退出
```

#### 场景B：无目标设备时
```
📱 (设备总数)
├── 🔄 刷新设备
├── 🔍 扫描设备
├── 📱 设备名称 (IP)           [灰色标题，不可点击]
│   ├── 📱 Scrcpy             [可直接点击]
│   ├── 🟢 SC                 [可直接点击]
│   ├── 🟡 SCA                [可直接点击]
│   ├── 🔴 SCB                [可直接点击]
│   └── 🔌 断开连接           [可直接点击]
├── ⚙️ 设置
├── 📋 历史记录
├── 🚀 启动GUI服务器
├── 🛑 停止GUI服务器
└── ❌ 退出
```

## 技术实现细节

### 1. 菜单项状态管理
- **标题项**：`setEnabled_(False)` - 灰色显示，不可点击
- **操作项**：`setEnabled_(True)` - 正常显示，可点击
- **子菜单项**：`setSubmenu_(submenu)` - 有子菜单的项

### 2. Action处理
- **刷新设备**：`refreshDevices:`
- **扫描设备**：`scanDevices:`
- **设置**：`showSettings:`
- **历史记录**：`showHistory:`
- **启动GUI服务器**：`startGUIServer:`
- **停止GUI服务器**：`stopGUIServer:`
- **退出**：`quitApp:`
- **设备操作**：
  - Scrcpy：`launchScrcpy:`
  - SC：`launchSC:`
  - SCA：`launchSCA:`
  - SCB：`launchSCB:`
  - 断开连接：`disconnectDevice:`
  - 选择设备：`selectDevice:`

### 3. 设备信息存储
- **设备ID**：`setRepresentedObject_(device_id)`
- **目标设备名**：`self.target_device_name`（默认"110"）

### 4. 菜单更新逻辑
1. 清理现有菜单项：`cleanup_device_control_items()`
2. 分类设备：目标设备 vs 其他设备
3. 根据设备类型构建菜单结构
4. 动态插入菜单项到主菜单

### 5. 设置功能
- **目标设备设置**：通过文本输入框修改`self.target_device_name`
- **实时更新**：设置更改后立即刷新菜单显示
- **输入验证**：防止设置空值

### 6. 清理机制
- **动态菜单项**：所有动态添加的菜单项都存储在`self.device_control_items`中
- **清理方法**：`cleanup_device_control_items()`负责清理动态项
- **可见性重置**：清理时重置菜单项可见性状态

## 设备操作命令

### 1. Scrcpy
- **命令**：`scrcpy -s device_id`
- **说明**：直接使用scrcpy命令进行屏幕镜像

### 2. SC/SCA/SCB
- **说明**：使用自定义脚本，需要加载toolsinit.sh
- **实现**：通过zsh执行，支持别名
- **IP处理**：自动提取IP地址（去掉端口号）

### 3. 断开连接
- **命令**：`adb disconnect device_id`
- **说明**：断开指定设备的ADB连接

## 通知系统

### 1. 操作反馈
- **成功通知**：操作完成后显示成功消息
- **错误通知**：操作失败时显示错误信息
- **扫描状态**：扫描开始、完成、超时等状态通知

### 2. 设备状态
- **连接状态**：设备连接/断开时更新菜单
- **扫描进度**：扫描过程中的状态提示

## 配置和持久化

### 1. 目标设备设置
- **默认值**："110"
- **存储方式**：内存中的类属性
- **生效方式**：实时更新菜单结构

### 2. 历史记录
- **存储文件**：`ip.txt`
- **用途**：显示历史连接的设备IP
- **格式**：每行一个IP地址

## 错误处理

### 1. ADB命令错误
- **超时处理**：命令执行超时捕获
- **命令未找到**：ADB工具未安装时的提示
- **权限问题**：ADB权限相关错误处理

### 2. 网络扫描错误
- **脚本不存在**：scan.command文件缺失提示
- **扫描超时**：网络扫描超时处理
- **执行错误**：扫描过程中的异常处理

### 3. 菜单操作错误
- **无效设备ID**：设备ID格式验证
- **空输入验证**：设置功能中的输入验证
- **菜单状态异常**：菜单项状态管理异常处理

## 扩展性考虑

### 1. 新增设备类型
- 可以通过修改设备分类逻辑支持更多设备类型
- 支持正则表达式匹配设备名称

### 2. 新增操作命令
- 可以轻松添加新的设备操作命令
- 支持自定义命令模板

### 3. 菜单结构调整
- 支持多级菜单结构
- 可以根据设备数量动态调整菜单复杂度

### 4. 设置功能扩展
- 可以添加更多配置选项
- 支持配置文件持久化

## 维护说明

### 1. 代码结构
- `update_device_menu()`: 核心菜单更新逻辑
- `cleanup_device_control_items()`: 菜单项清理
- `show_settings()`: 设置功能实现
- 各launch方法：设备操作实现

### 2. 关键变量
- `self.devices`: 当前设备列表
- `self.target_device_name`: 目标设备名称
- `self.device_control_items`: 动态菜单项列表
- `self.device_menu`: 设备列表子菜单

### 3. 文件依赖
- `scan.command`: 设备扫描脚本
- `ip.txt`: 历史连接记录
- `gui-launcher.command`: GUI服务器启动脚本
- `toolsinit.sh`: 自定义脚本函数库

---

**文档版本**: v1.0  
**最后更新**: 2025-08-08  
**维护者**: Claude Code